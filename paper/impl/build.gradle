import java.nio.charset.StandardCharsets

plugins {
    id 'io.github.goooler.shadow' version '8.1.8' apply false //Makes it available to subprojects
}

var author = project.findProperty('author')
var apiVersion = project.findProperty('apiVersion')?.toDouble()
description = "Implementation parent module"

def crescentcore_version = project.findProperty('crescentcore_version')
def jumpwarps_version = project.findProperty('jumpwarps_version')
def artifacts_version = project.findProperty('artifacts_version')
def crystals_version = project.findProperty('crystals_version')
def dropnames_version = project.findProperty('dropnames_version')
def commandtomes_version = project.findProperty('commandtomes_version')

void addRepositories(Project project) {
    project.repositories {
        mavenCentral()
        maven { url = uri('https://repo.papermc.io/repository/maven-public/') }
        maven { url = uri('https://oss.sonatype.org/content/groups/public/') }
        maven { url = uri('https://repo.triumphteam.dev/snapshots/') }
        maven { url = uri('https://repo.maven.apache.org/maven2/') }
        maven { url = uri('https://crescentsun.it/reposilite/releases') }
        maven { url  = uri("https://maven.mrnavastar.me/releases") }
    }
}

subprojects {
    apply plugin: 'maven-publish'
    apply plugin: 'java-library'
    apply plugin: 'io.github.goooler.shadow'

    addRepositories(project)

    java {
        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
    }

    project.version = [
            "crescent-core"            : crescentcore_version,
            "jumpwarps"                 : jumpwarps_version,
            "artifacts"                     : artifacts_version,
            "crystals"                      : crystals_version,
            "dropnames"                : dropnames_version,
            "command-tomes"      : commandtomes_version
    ].get(project.name)
    project.group = "it.crescentsun"
    project.description = project.description ?: "No description provided"

    tasks.withType(JavaCompile).configureEach {
        options.encoding = "UTF-8"
    }

    shadowJar {
        archiveClassifier.set("")
        relocate 'dev.triumphteam.cmd', 'it.crescentsun.cmd'
        exclude 'me/mrnavastar/**'
    }

    build {
        group = 'always-used'
        dependsOn(shadowJar)
    }
    copyJarToRemote {
        group = 'always-used'
    }

    dependencies {
        implementation libs.triumph.cmd
        compileOnly libs.paper.api

        if (project.name.equalsIgnoreCase("crescent-core")) {
            implementation libs.crescent.common
            implementation libs.crescentmsg
            implementation libs.crescent.core.api
        } else {
            compileOnly libs.crescent.common
            compileOnly libs.crescentmsg
            compileOnly libs.crescent.core.api
        }
    }

    afterEvaluate {
        project.tasks.processResources {
            filteringCharset = StandardCharsets.UTF_8.name()
            def props = [
                    "name"           : project.name,
                    "description" : project.description,
                    "version"        : project.version,
                    "apiVersion"   : apiVersion,
                    "author"          : author
            ]
            inputs.properties(props)
            filesMatching("plugin.yml") {
                expand(props)
            }
        }
    }
}

tasks.register("copyAllToRemote") {
    group = 'always-used'
    description = 'Copies all subprojects to the remote server - without flags.'
    dependsOn(subprojects.collect { it.tasks.named("copyJarToRemote") })
}